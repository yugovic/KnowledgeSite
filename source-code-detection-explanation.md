# ソースコード除外ロジックの説明

## 実装した機能

Claude Companion のキーワード分析において、ユーザーがペーストしたソースコードから抽出される単語を除外するロジックを実装しました。

## 1. ソースコード検出ロジック (`isSourceCode` メソッド)

### 検出基準（複数の指標を組み合わせて判定）

#### 即座に判定する条件:
- **コードブロックマーカー**: ``` が含まれている
- **関数定義の開始**: `function`, `class`, `const`, `let`, `var` などで始まる行
- **HTMLタグの連続**: 5個以上のHTMLタグが含まれている
- **CSSプロパティの連続**: 3個以上のCSSプロパティ定義が含まれている

#### 複合的な判定（3つ以上該当でソースコードと判定）:
1. **インデント率**: 全体の50%以上の行が2文字以上のインデントを持つ
2. **プログラミング記号の頻度**: `{}()[];=><` などの記号が全文字数の5%以上
3. **プログラミング定義の数**: `function`, `const`, `import` などの定義が3個以上
4. **コメント行の数**: `//`, `#`, `/*`, `*` で始まる行が2行以上

## 2. キーワード除外ロジック (`extractKeywords` メソッド)

### 除外される単語のカテゴリ:

#### プログラミング用語の除外:
```javascript
// 変数名でよく使われる単語
'data', 'item', 'value', 'key', 'index', 'result', 'error', 'message'

// 一般的なプログラミング用語
'function', 'class', 'method', 'true', 'false', 'null', 'undefined'

// HTMLタグ名
'div', 'span', 'button', 'input', 'form', 'table'
```

#### 日本語ストップワードの除外:
```javascript
// 助詞や接続詞
'です', 'ます', 'する', 'ある', 'なる', 'これ', 'それ'
'という', 'について', 'によって', 'のように'
```

### 追加の除外条件:
- **数字のみの文字列**
- **1-2文字の英単語**
- **CamelCaseの変数名** (例: `getUserName`)
- **20文字以上の長い文字列**

### 含める条件:
- **日本語を含む単語**
- **大文字で始まる適切な英単語** (例: `Claude`)
- **5文字以上の意味のある英単語**

## 3. 処理フロー

```
1. メッセージを受信
   ↓
2. isSourceCode() でソースコードかチェック
   ↓
3. ソースコードの場合:
   - 性格分析は実行（技術力の判定などに使用）
   - キーワード抽出はスキップ
   ↓
4. 通常のメッセージの場合:
   - 全ての分析を実行
   - キーワードを抽出（除外リストを適用）
```

## 効果

この実装により:
- `initialize`, `anonymous`, `errorhandler` などのプログラミング用語が除外されます
- 「ありがとう」「プロジェクト」「分析」など、実際の会話で使われた単語が抽出されます
- より正確なユーザーの言語使用パターンが把握できます

## 今後の改善案

1. **機械学習による判定**: より高度なソースコード検出
2. **言語別の除外リスト**: JavaScript, Python, Java など言語別の最適化
3. **文脈を考慮した判定**: 前後のメッセージから判断
4. **ユーザー設定**: 除外したい単語をカスタマイズ可能に